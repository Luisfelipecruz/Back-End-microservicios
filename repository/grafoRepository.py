from fastapi import HTTPException, status
from schemas import grafoSchema
from models import edificioModel
from sqlalchemy.orm import Session
import heapq
import sys


class Graph:

    def __init__(self):
        self.vertices = {}

    def add_vertex(self, name, edges):
        self.vertices[name] = edges

    def shortest_path(self, start, finish):
        distances = {}  # Distance from start to node
        previous = {}  # Previous node in optimal path from source
        nodes = []  # Priority queue of all nodes in Graph

        for vertex in self.vertices:
            if vertex == start:  # Set root node as distance of 0
                distances[vertex] = 0
                heapq.heappush(nodes, [0, vertex])
            else:
                distances[vertex] = sys.maxsize
                heapq.heappush(nodes, [sys.maxsize, vertex])
            previous[vertex] = None

        while nodes:
            smallest = heapq.heappop(nodes)[1]  # Vertex in nodes with smallest distance in distances
            if smallest == finish:  # If the closest node is our target we're done so print the path
                path = []
                while previous[smallest]:  # Traverse through nodes til we reach the root which is 0
                    path.append(smallest)
                    smallest = previous[smallest]
                return path
            if distances[smallest] == sys.maxsize:  # All remaining vertices are inaccessible from source
                break

            for neighbor in self.vertices[smallest]:  # Look at all the nodes that this vertex is attached to
                alt = distances[smallest] + self.vertices[smallest][neighbor]  # Alternative path distance
                if alt < distances[neighbor]:  # If there is a new shortest path update our priority queue (relax)
                    distances[neighbor] = alt
                    previous[neighbor] = smallest
                    for n in nodes:
                        if n[1] == neighbor:
                            n[0] = alt
                            break
                    heapq.heapify(nodes)
        return distances

    def __str__(self):
        return str(self.vertices)


def bucar_camino_mas_corto(request: grafoSchema.Grafo):

    g = Graph()
    g.add_vertex('0', {'1': 13.6482249477})
    g.add_vertex('1', {'0': 13.6482249477, '85': 13.1833637034, '154': 74.4117682812})
    g.add_vertex('2', {'3': 6.6069473082000005, '4': 37.168531924499995, '154': 33.8150285573})
    g.add_vertex('3', {'2': 6.6069473082000005})
    g.add_vertex('4', {'2': 37.168531924499995, '5': 40.8621199786, '10': 34.2235573659})
    g.add_vertex('5', {'4': 40.8621199786, '6': 13.5864527168, '7': 22.906147655999998, '8': 35.3146749874})
    g.add_vertex('6', {'5': 13.5864527168})
    g.add_vertex('7', {'5': 22.906147655999998})
    g.add_vertex('8', {'5': 35.3146749874, '9': 8.08040875743, '60': 12.719067515899999})
    g.add_vertex('9', {'8': 8.08040875743})
    g.add_vertex('10', {'4': 34.2235573659, '11': 10.605345049, '12': 72.0324557433})
    g.add_vertex('11', {'10': 10.605345049})
    g.add_vertex('12', {'10': 72.0324557433, '13': 19.2142488656, '68': 42.5827012886})
    g.add_vertex('13', {'12': 19.2142488656, '14': 33.757669152199995, '15': 40.233839579299996})
    g.add_vertex('14', {'13': 33.757669152199995, '20': 7.615918194860001, '21': 15.9654769802})
    g.add_vertex('15', {'13': 40.233839579299996, '68': 19.0773163403, '18': 30.4037715328})
    g.add_vertex('16', {'17': 18.0210320025, '32': 32.0712474288, '75': 42.7635891402, '18': 12.9381831402})
    g.add_vertex('17', {'16': 18.0210320025})
    g.add_vertex('18', {'19': 7.72000552719, '15': 30.4037715328, '16': 12.9381831402})
    g.add_vertex('19', {'18': 7.72000552719})
    g.add_vertex('20', {'14': 7.615918194860001})
    g.add_vertex('21', {'22': 29.4421224418, '14': 15.9654769802, '32': 56.157619976999996, '29': 33.2105730818})
    g.add_vertex('22', {'21': 29.4421224418, '23': 8.82714656591, '24': 18.3922213076})
    g.add_vertex('23', {'22': 8.82714656591})
    g.add_vertex('24', {'22': 18.3922213076, '25': 12.9988830818, '26': 21.823077054099997})
    g.add_vertex('25', {'24': 12.9988830818})
    g.add_vertex('26', {'24': 21.823077054099997, '27': 19.4938810948, '29': 25.948577167399996})
    g.add_vertex('27', {'26': 19.4938810948, '28': 15.8068020022, '59': 35.7934990721})
    g.add_vertex('28', {'27': 15.8068020022})
    g.add_vertex('29', {'26': 25.948577167399996, '30': 27.5557851648, '32': 49.819327662, '21': 33.2105730818})
    g.add_vertex('30', {'29': 27.5557851648, '31': 16.5230721318, '52': 20.8790915608})
    g.add_vertex('31', {'30': 16.5230721318})
    g.add_vertex('32', {'29': 49.819327662, '33': 16.5180562823, '34': 39.2000553217, '21': 56.157619976999996,
                        '16': 32.0712474288})
    g.add_vertex('33', {'32': 16.5180562823})
    g.add_vertex('34', {'32': 39.2000553217, '35': 35.4714201072, '38': 28.1774045479})
    g.add_vertex('35', {'34': 35.4714201072, '36': 6.97891472725, '37': 4.31165106068})
    g.add_vertex('36', {'35': 6.97891472725})
    g.add_vertex('37', {'35': 4.31165106068})
    g.add_vertex('38', {'34': 28.1774045479, '39': 8.74906755708, '40': 11.6182223034})
    g.add_vertex('39', {'38': 8.74906755708})
    g.add_vertex('40', {'38': 11.6182223034, '43': 32.7448425749, '112': 33.9831474154})
    g.add_vertex('41', {'42': 9.28695165454, '43': 19.6303175201, '45': 36.3170178178, '50': 38.2614285002})
    g.add_vertex('42', {'41': 9.28695165454})
    g.add_vertex('43', {'40': 32.7448425749, '41': 19.6303175201, '44': 37.2052532279})
    g.add_vertex('44', {'43': 37.2052532279, '45': 23.3536784807, '53': 15.0712028723})
    g.add_vertex('45', {'41': 36.3170178178, '44': 23.3536784807, '46': 26.1132010815, '49': 13.9095944675})
    g.add_vertex('46', {'45': 26.1132010815, '47': 13.7391266876, '55': 24.437113253699998})
    g.add_vertex('47', {'46': 13.7391266876, '48': 4.088410054180001, '49': 26.367999631799997})
    g.add_vertex('48', {'47': 4.088410054180001})
    g.add_vertex('49', {'47': 26.367999631799997, '45': 13.9095944675, '50': 43.8368462014, '51': 21.069508188})
    g.add_vertex('50', {'49': 43.8368462014, '41': 38.2614285002, '51': 37.080354266, '119': 26.844895759699998})
    g.add_vertex('51', {'49': 21.069508188, '50': 37.080354266, '120': 32.666914857600005})
    g.add_vertex('52', {'30': 20.8790915608, '53': 25.1239797633})
    g.add_vertex('53', {'52': 25.1239797633, '44': 15.0712028723, '54': 38.747227573800004})
    g.add_vertex('54', {'55': 31.427574797, '57': 30.1251354575, '58': 33.9865449975, '53': 38.747227573800004})
    g.add_vertex('55', {'54': 31.427574797, '46': 24.437113253699998, '56': 28.242476480900002})
    g.add_vertex('56', {'55': 28.242476480900002, '57': 12.6436851524, '102': 37.7551919117})
    g.add_vertex('57', {'54': 30.1251354575, '56': 12.6436851524, '58': 49.5322769908})
    g.add_vertex('58', {'57': 49.5322769908, '54': 33.9865449975, '59': 28.191381173000003, '61': 7.69301908655})
    g.add_vertex('59', {'27': 35.7934990721, '58': 28.191381173000003, '60': 9.767377241939998})
    g.add_vertex('60', {'59': 9.767377241939998, '8': 12.719067515899999, '64': 31.85718289})
    g.add_vertex('61', {'58': 7.69301908655, '62': 30.5038173133})
    g.add_vertex('62', {'61': 30.5038173133, '63': 13.7498442852, '64': 29.2181946359, '104': 23.256720337199997})
    g.add_vertex('63', {'62': 13.7498442852})
    g.add_vertex('64', {'62': 29.2181946359, '60': 31.85718289, '65': 17.0647300008, '84': 37.6430585501})
    g.add_vertex('65', {'64': 17.0647300008, '66': 9.66950883587, '67': 9.89897598939, '78': 30.965476307600003})
    g.add_vertex('66', {'65': 9.66950883587})
    g.add_vertex('67', {'65': 9.89897598939})
    g.add_vertex('68', {'12': 42.5827012886, '15': 19.0773163403, '69': 28.927170910999997})
    g.add_vertex('69', {'68': 28.927170910999997, '70': 4.79200468384, '71': 15.5704830944})
    g.add_vertex('70', {'69': 4.79200468384})
    g.add_vertex('71', {'69': 15.5704830944, '72': 31.6337484862})
    g.add_vertex('72', {'71': 31.6337484862, '73': 5.29122326071, '74': 22.4680758871})
    g.add_vertex('73', {'72': 5.29122326071})
    g.add_vertex('74', {'72': 22.4680758871, '75': 14.835885593299999, '156': 24.811865752})
    g.add_vertex('75', {'74': 14.835885593299999, '16': 42.7635891402})
    g.add_vertex('76', {'77': 26.6555234448, '79': 16.0214179445, '85': 43.877620630600006})
    g.add_vertex('77', {'76': 26.6555234448, '80': 23.394276766199997, '81': 25.1124861062, '83': 49.0180956325})
    g.add_vertex('78', {'65': 30.965476307600003, '81': 24.8770461713, '84': 13.5878952957})
    g.add_vertex('79', {'76': 16.0214179445})
    g.add_vertex('80', {'77': 23.394276766199997})
    g.add_vertex('81', {'77': 25.1124861062, '82': 15.6605663365, '78': 24.8770461713})
    g.add_vertex('82', {'81': 15.6605663365})
    g.add_vertex('83', {'77': 49.0180956325, '84': 34.1802196133, '89': 71.4211369362, '98': 19.4753841137,
                        '108': 59.5744187799})
    g.add_vertex('84', {'83': 34.1802196133, '64': 37.6430585501, '78': 13.5878952957})
    g.add_vertex('85', {'1': 13.1833637034, '76': 43.877620630600006, '86': 36.8394770881})
    g.add_vertex('86', {'85': 36.8394770881, '87': 22.657468837, '88': 29.5809476524})
    g.add_vertex('87', {'86': 22.657468837})
    g.add_vertex('88', {'86': 29.5809476524, '89': 97.70943677049999, '152': 42.426206228699996, '153': 53.6333038962})
    g.add_vertex('89', {'88': 97.70943677049999, '83': 71.4211369362, '151': 45.7112348321, '153': 52.2653383225})
    g.add_vertex('98', {'83': 19.4753841137, '99': 21.970311554299997, '100': 17.1421297554})
    g.add_vertex('90', {'91': 11.331677008900002, '92': 36.285454634699995, '108': 19.2414445948, '100': 16.8907340765})
    g.add_vertex('91', {'90': 11.331677008900002})
    g.add_vertex('92', {'90': 36.285454634699995, '93': 24.9915080335, '94': 24.5523224034})
    g.add_vertex('93', {'92': 24.9915080335})
    g.add_vertex('94', {'92': 24.5523224034, '95': 14.4830556519, '96': 19.2393535615, '97': 19.911480441400002})
    g.add_vertex('95', {'94': 14.4830556519})
    g.add_vertex('96', {'94': 19.2393535615})
    g.add_vertex('97', {'94': 19.911480441400002, '149': 25.8787358029})
    g.add_vertex('99', {'98': 21.970311554299997})
    g.add_vertex('100', {'101': 13.362171057000001, '98': 17.1421297554, '90': 16.8907340765})
    g.add_vertex('101', {'100': 13.362171057000001})
    g.add_vertex('102', {'56': 37.7551919117, '103': 5.66212474647, '105': 11.827144417000001})
    g.add_vertex('103', {'102': 5.66212474647})
    g.add_vertex('104', {'62': 23.256720337199997, '105': 61.3761848428, '108': 55.9978612591})
    g.add_vertex('105', {'104': 61.3761848428, '102': 11.827144417000001, '106': 40.6273403497})
    g.add_vertex('106',
                 {'105': 40.6273403497, '107': 8.74515576885, '108': 23.375253798499998, '132': 25.804739884099998,
                  '134': 20.1448370128})
    g.add_vertex('107', {'106': 8.74515576885})
    g.add_vertex('108', {'83': 59.5744187799, '104': 55.9978612591, '106': 23.375253798499998, '109': 7.97785733675,
                         '90': 19.2414445948})
    g.add_vertex('109', {'108': 7.97785733675})
    g.add_vertex('111', {'110': 4.42422192975})
    g.add_vertex('110', {'111': 4.42422192975, '115': 16.9174769293, '116': 22.3735212125, '161': 27.885154798200002})
    g.add_vertex('112',
                 {'40': 33.9831474154, '113': 12.107810477200001, '114': 48.7863841354, '115': 11.030243860999999})
    g.add_vertex('113', {'112': 12.107810477200001})
    g.add_vertex('114', {'112': 48.7863841354, '158': 42.6545897899, '160': 45.822812587})
    g.add_vertex('115', {'112': 11.030243860999999, '110': 16.9174769293})
    g.add_vertex('116',
                 {'110': 22.3735212125, '117': 13.8952012843, '118': 12.113159984400001, '119': 22.395360239099997})
    g.add_vertex('117', {'116': 13.8952012843})
    g.add_vertex('118', {'116': 12.113159984400001})
    g.add_vertex('119',
                 {'116': 22.395360239099997, '50': 26.844895759699998, '161': 15.978135373499999, '162': 57.6865488496})
    g.add_vertex('120', {'51': 32.666914857600005, '121': 26.043002242600004})
    g.add_vertex('121',
                 {'120': 26.043002242600004, '122': 26.8622361879, '123': 59.547657800399996, '127': 41.8242033542})
    g.add_vertex('122', {'121': 26.8622361879})
    g.add_vertex('123',
                 {'121': 59.547657800399996, '124': 23.026486232800004, '125': 56.548579645100006, '163': 60.469797899,
                  '167': 48.497872600600004})
    g.add_vertex('124', {'123': 23.026486232800004})
    g.add_vertex('125', {'123': 56.548579645100006, '126': 10.2545989862, '163': 39.4920486952, '164': 83.3916224563,
                         '167': 56.3916790562})
    g.add_vertex('126', {'125': 10.2545989862, '163': 43.7083319521, '164': 85.5484442046})
    g.add_vertex('127', {'121': 41.8242033542, '128': 9.38359933914, '129': 29.214802274})
    g.add_vertex('128', {'127': 9.38359933914})
    g.add_vertex('129', {'127': 29.214802274, '130': 16.8795852219, '131': 34.1900087436})
    g.add_vertex('130', {'129': 16.8795852219})
    g.add_vertex('131', {'129': 34.1900087436, '132': 23.9505073915, '136': 28.7006450248, '138': 31.4521515281})
    g.add_vertex('132', {'131': 23.9505073915, '106': 25.804739884099998, '133': 13.4613780425, '134': 20.1565644055})
    g.add_vertex('133', {'132': 13.4613780425})
    g.add_vertex('134', {'106': 20.1448370128, '135': 8.7325107146, '136': 14.495399413, '132': 20.1565644055,
                         '137': 25.9239628468})
    g.add_vertex('135', {'134': 8.7325107146})
    g.add_vertex('136', {'134': 14.495399413, '131': 28.7006450248, '140': 23.799698500799998, '141': 36.0379773641})
    g.add_vertex('137', {'134': 25.9239628468, '141': 21.0385621658})
    g.add_vertex('138', {'131': 31.4521515281, '139': 16.4408039386, '166': 59.8826785938})
    g.add_vertex('139', {'138': 16.4408039386})
    g.add_vertex('140', {'136': 23.799698500799998})
    g.add_vertex('141', {'136': 36.0379773641, '142': 10.495201337200001, '137': 21.0385621658, '143': 19.1992551902})
    g.add_vertex('142', {'141': 10.495201337200001})
    g.add_vertex('143', {'141': 19.1992551902, '144': 22.944652747600003, '145': 11.16504555, '146': 13.5894085541})
    g.add_vertex('144', {'143': 22.944652747600003})
    g.add_vertex('145', {'143': 11.16504555})
    g.add_vertex('146', {'143': 13.5894085541, '147': 7.8506649281, '148': 42.8616376519})
    g.add_vertex('147', {'146': 7.8506649281})
    g.add_vertex('148', {'146': 42.8616376519, '149': 90.5492040319, '198': 30.6738566, '199': 31.157350611})
    g.add_vertex('149', {'148': 90.5492040319, '97': 25.8787358029, '150': 44.1670467924, '151': 49.029387530600005})
    g.add_vertex('150', {'149': 44.1670467924})
    g.add_vertex('151', {'89': 45.7112348321, '149': 49.029387530600005, '152': 98.07145630209999, '153': 54.1355370785,
                         '171': 38.8401801027})
    g.add_vertex('152',
                 {'88': 42.426206228699996, '151': 98.07145630209999, '153': 54.770266867299995, '168': 10.9183204281})
    g.add_vertex('153', {'89': 52.2653383225, '152': 54.770266867299995, '88': 53.6333038962, '151': 54.1355370785})
    g.add_vertex('154', {'155': 16.4803427166, '1': 74.4117682812, '2': 33.8150285573})
    g.add_vertex('155', {'154': 16.4803427166})
    g.add_vertex('156', {'74': 24.811865752, '157': 16.0678463421, '158': 67.27698018560001})
    g.add_vertex('157', {'156': 16.0678463421})
    g.add_vertex('158', {'156': 67.27698018560001, '159': 17.7376627622, '114': 42.6545897899})
    g.add_vertex('159', {'158': 17.7376627622})
    g.add_vertex('160', {'114': 45.822812587, '161': 49.7225934162, '162': 78.8017257993})
    g.add_vertex('161', {'160': 49.7225934162, '110': 27.885154798200002, '119': 15.978135373499999})
    g.add_vertex('162', {'160': 78.8017257993, '119': 57.6865488496, '163': 49.8960225343})
    g.add_vertex('163', {'123': 60.469797899, '162': 49.8960225343, '125': 39.4920486952, '126': 43.7083319521})
    g.add_vertex('164', {'125': 83.3916224563, '165': 9.57246475899, '166': 43.3920750468, '167': 41.9135240168,
                         '126': 85.5484442046})
    g.add_vertex('165', {'164': 9.57246475899, '166': 46.855755640699996})
    g.add_vertex('166', {'164': 43.3920750468, '167': 73.1176785184, '138': 59.8826785938, '165': 46.855755640699996})
    g.add_vertex('167', {'166': 73.1176785184, '123': 48.497872600600004, '164': 41.9135240168, '125': 56.3916790562})
    g.add_vertex('168', {'152': 10.9183204281, '169': 130.128297898})
    g.add_vertex('169', {'168': 130.128297898, '170': 76.58716095439999, '188': 50.4730534917})
    g.add_vertex('170', {'169': 76.58716095439999, '174': 21.7289128082, '176': 14.4677862286, '173': 30.2491209834})
    g.add_vertex('171', {'151': 38.8401801027, '172': 5.92419277291, '206': 32.1211745231})
    g.add_vertex('172', {'171': 5.92419277291})
    g.add_vertex('173', {'174': 41.0650923042, '170': 30.2491209834, '206': 45.7473198609})
    g.add_vertex('174', {'173': 41.0650923042, '175': 23.5176448289, '170': 21.7289128082, '178': 11.1577710286})
    g.add_vertex('175', {'174': 23.5176448289, '180': 9.52191987568, '200': 36.628907915300005})
    g.add_vertex('176', {'170': 14.4677862286, '177': 8.17264435379, '178': 23.2072773808, '182': 31.5462807525})
    g.add_vertex('177', {'176': 8.17264435379})
    g.add_vertex('178', {'176': 23.2072773808, '174': 11.1577710286, '179': 8.63016457221, '180': 23.1330386955})
    g.add_vertex('179', {'178': 8.63016457221})
    g.add_vertex('180', {'178': 23.1330386955, '175': 9.52191987568, '181': 8.18346172667, '197': 37.968827721,
                         '200': 37.284691860500004})
    g.add_vertex('181', {'180': 8.18346172667})
    g.add_vertex('182', {'176': 31.5462807525, '183': 56.886760136599996, '205': 29.9824651787})
    g.add_vertex('183', {'182': 56.886760136599996, '184': 5.31826561295, '185': 28.0149319119, '188': 19.3272321121})
    g.add_vertex('184', {'183': 5.31826561295})
    g.add_vertex('185', {'183': 28.0149319119, '186': 7.29518489362, '187': 14.016640049000001, '188': 30.4948583412})
    g.add_vertex('186', {'185': 7.29518489362})
    g.add_vertex('187', {'185': 14.016640049000001, '188': 35.0235858273, '209': 18.3374781907})
    g.add_vertex('188', {'169': 50.4730534917, '183': 19.3272321121, '185': 30.4948583412, '187': 35.0235858273})
    g.add_vertex('209', {'187': 18.3374781907, '189': 35.7424453218})
    g.add_vertex('189', {'190': 30.9670415653, '210': 46.683846894300004, '209': 35.7424453218})
    g.add_vertex('190', {'189': 30.9670415653})
    g.add_vertex('210', {'189': 46.683846894300004, '211': 42.8204677401})
    g.add_vertex('191', {'192': 6.3977545866100005, '207': 12.073268940799998, '211': 27.919613765799998})
    g.add_vertex('192', {'191': 6.3977545866100005})
    g.add_vertex('193', {'194': 39.0976912158, '195': 64.0643607442, '201': 40.6099243402})
    g.add_vertex('194', {'193': 39.0976912158})
    g.add_vertex('195', {'193': 64.0643607442, '196': 5.7015204797, '208': 54.0217880433})
    g.add_vertex('196', {'195': 5.7015204797})
    g.add_vertex('197', {'180': 37.968827721})
    g.add_vertex('198', {'148': 30.6738566})
    g.add_vertex('199', {'148': 31.157350611, '220': 41.0237264907, '222': 40.206782796700004})
    g.add_vertex('200', {'175': 36.628907915300005, '180': 37.284691860500004, '203': 75.477833368})
    g.add_vertex('201', {'202': 15.454022689, '193': 40.6099243402, '212': 13.2177590378})
    g.add_vertex('202', {'201': 15.454022689})
    g.add_vertex('203', {'204': 8.98574976162, '200': 75.477833368, '221': 23.049557921399998})
    g.add_vertex('204', {'203': 8.98574976162})
    g.add_vertex('205', {'182': 29.9824651787})
    g.add_vertex('206', {'173': 45.7473198609, '171': 32.1211745231})
    g.add_vertex('207', {'191': 12.073268940799998, '208': 5.79602837436})
    g.add_vertex('208', {'207': 5.79602837436, '195': 54.0217880433})
    g.add_vertex('212', {'201': 13.2177590378, '213': 17.9191534822})
    g.add_vertex('213', {'212': 17.9191534822, '214': 37.303888092600005})
    g.add_vertex('214', {'213': 37.303888092600005, '215': 34.7633878592})
    g.add_vertex('215', {'214': 34.7633878592, '216': 13.8844056303})
    g.add_vertex('216', {'215': 13.8844056303, '217': 27.355296631199998})
    g.add_vertex('217', {'216': 27.355296631199998, '218': 26.7800091352})
    g.add_vertex('218', {'217': 26.7800091352, '219': 16.6133397212})
    g.add_vertex('219', {'218': 16.6133397212, '220': 13.5227427107})
    g.add_vertex('220', {'219': 13.5227427107, '199': 41.0237264907})
    g.add_vertex('221', {'203': 23.049557921399998, '223': 24.938237430100003})
    g.add_vertex('223', {'221': 24.938237430100003, '222': 27.9095116684})
    g.add_vertex('222', {'223': 27.9095116684, '199': 40.206782796700004})
    g.add_vertex('211', {'210': 42.8204677401, '191': 27.919613765799998})

    respuesta_list = g.shortest_path(request.Pnt_inicial, request.Pnt_final)

    if not respuesta_list:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND,
                            detail=f"No es posible encontrar la ruta mas corta entre los dos puntos dados ")
    return respuesta_list[::-1]


def listarALLedificios(db: Session):
    edificios = db.query(edificioModel.Edificio).all()
    return edificios

